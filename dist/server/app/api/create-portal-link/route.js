(()=>{var e={};e.id=610,e.ids=[610],e.modules={30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},4074:e=>{"use strict";e.exports=require("perf_hooks")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},79767:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>v,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>g});var a={};r.r(a),r.d(a,{POST:()=>m});var i=r(10884),n=r(16132),s=r(21040),o=r(84970),d=r(4999),l=r(92974),c=r(46813),u=r(24596),p=r(95798);async function m(){try{let e=(0,c.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:t}}=await e.auth.getUser();if(!t)throw Error("could not find the user");let r=await (0,d.F2)({email:t.email||"",uuid:t.id||""});if(!r)throw Error("No Customer");let{url:a}=await o.A.billingPortal.sessions.create({customer:r,return_url:`${(0,l.Ax)()}/dashboard`});return p.Z.json({url:a})}catch(e){return console.log("ERROR",e),new p.Z("Internal Error",{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/create-portal-link/route",pathname:"/api/create-portal-link",filename:"route",bundlePath:"app/api/create-portal-link/route"},resolvedPagePath:"G:\\notion\\src\\app\\api\\create-portal-link\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:y,headerHooks:w,staticGenerationBailout:g}=f,v="/api/create-portal-link/route";function A(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},26504:(e,t,r)=>{"use strict";r.r(t),r.d(t,{aalLevel:()=>w,codeChallengeMethod:()=>g,collaborators:()=>E,customers:()=>q,factorStatus:()=>y,factorType:()=>h,files:()=>I,folders:()=>N,keyStatus:()=>f,keyType:()=>_,prices:()=>T,pricesRelations:()=>C,pricingPlanInterval:()=>A,pricingType:()=>v,products:()=>k,productsRelations:()=>j,subscriptionStatus:()=>x,subscriptions:()=>S,users:()=>b,workspaces:()=>L});var a=r(92150),i=r(92407),n=r(73734),s=r(33789),o=r(63750),d=r(45191),l=r(55390),c=r(44406),u=r(10009),p=r(50091),m=r(54277);let f=(0,a.ys)("key_status",["default","valid","invalid","expired"]),_=(0,a.ys)("key_type",["aead-ietf","aead-det","hmacsha512","hmacsha256","auth","shorthash","generichash","kdf","secretbox","secretstream","stream_xchacha20"]),h=(0,a.ys)("factor_type",["totp","webauthn"]),y=(0,a.ys)("factor_status",["unverified","verified"]),w=(0,a.ys)("aal_level",["aal1","aal2","aal3"]),g=(0,a.ys)("code_challenge_method",["s256","plain"]),v=(0,a.ys)("pricing_type",["one_time","recurring"]),A=(0,a.ys)("pricing_plan_interval",["day","week","month","year"]),x=(0,a.ys)("subscription_status",["trialing","active","canceled","incomplete","incomplete_expired","past_due","unpaid"]),L=(0,i.af)("workspaces",{id:(0,n.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,s.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),workspaceOwner:(0,n.Vj)("workspace_owner").notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),logo:(0,o.fL)("logo"),bannerUrl:(0,o.fL)("banner_url")}),N=(0,i.af)("folders",{id:(0,n.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,s.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),bannerUrl:(0,o.fL)("banner_url"),workspaceId:(0,n.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"})}),I=(0,i.af)("files",{id:(0,n.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,s.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),bannerUrl:(0,o.fL)("banner_url"),workspaceId:(0,n.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"}),folderId:(0,n.Vj)("folder_id").notNull().references(()=>N.id,{onDelete:"cascade"})}),b=(0,i.af)("users",{id:(0,n.Vj)("id").primaryKey().notNull(),fullName:(0,o.fL)("full_name"),avatarUrl:(0,o.fL)("avatar_url"),billingAddress:(0,d.JB)("billing_address"),updatedAt:(0,s.AB)("updated_at",{withTimezone:!0,mode:"string"}),paymentMethod:(0,d.JB)("payment_method"),email:(0,o.fL)("email")}),q=(0,i.af)("customers",{id:(0,n.Vj)("id").primaryKey().notNull(),stripeCustomerId:(0,o.fL)("stripe_customer_id")}),T=(0,i.af)("prices",{id:(0,o.fL)("id").primaryKey().notNull(),productId:(0,o.fL)("product_id").references(()=>k.id),active:(0,l.O7)("active"),description:(0,o.fL)("description"),unitAmount:(0,c.Kv)("unit_amount",{mode:"number"}),currency:(0,o.fL)("currency"),type:v("type"),interval:A("interval"),intervalCount:(0,u._L)("interval_count"),trialPeriodDays:(0,u._L)("trial_period_days"),metadata:(0,d.JB)("metadata")}),k=(0,i.af)("products",{id:(0,o.fL)("id").primaryKey().notNull(),active:(0,l.O7)("active"),name:(0,o.fL)("name"),description:(0,o.fL)("description"),image:(0,o.fL)("image"),metadata:(0,d.JB)("metadata")}),S=(0,i.af)("subscriptions",{id:(0,o.fL)("id").primaryKey().notNull(),userId:(0,n.Vj)("user_id").notNull(),status:x("status"),metadata:(0,d.JB)("metadata"),priceId:(0,o.fL)("price_id").references(()=>T.id),quantity:(0,u._L)("quantity"),cancelAtPeriodEnd:(0,l.O7)("cancel_at_period_end"),created:(0,s.AB)("created",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodStart:(0,s.AB)("current_period_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodEnd:(0,s.AB)("current_period_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),endedAt:(0,s.AB)("ended_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),cancelAt:(0,s.AB)("cancel_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),canceledAt:(0,s.AB)("canceled_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialStart:(0,s.AB)("trial_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialEnd:(0,s.AB)("trial_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`)}),E=(0,i.af)("collaborators",{workspaceId:(0,n.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"}),cancelAt:(0,s.AB)("cancel_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),userId:(0,n.Vj)("user_id").notNull().references(()=>b.id,{onDelete:"cascade"}),id:(0,n.Vj)("id").defaultRandom().notNull()}),j=(0,m.lE)(k,({many:e})=>({prices:e(T)})),C=(0,m.lE)(T,({one:e})=>({product:e(k,{fields:[T.productId],references:[k.id]})}))},4999:(e,t,r)=>{"use strict";r.d(t,{CM:()=>p,F2:()=>c,OF:()=>l,aU:()=>d});var a=r(48386),i=r(26504),n=r(84970),s=r(50161),o=r(92974);let d=async e=>{let t={id:e.id,active:e.active,name:e.name,description:e.description??null,image:e.images?.[0]??null,metadata:e.metadata};try{await a.Z.insert(i.products).values(t).onConflictDoUpdate({target:i.products.id,set:t})}catch(e){throw Error()}console.log("Product inserted/updates:",e.id)},l=async e=>{console.log(e,"PRICE");let t={id:e.id,productId:"string"==typeof e.product?e.product:null,active:e.active,currency:e.currency,description:e.nickname??null,type:e.type,unitAmount:e.unit_amount??null,interval:e.recurring?.interval??null,intervalCount:e.recurring?.interval_count??null,trialPeriodDays:e.recurring?.trial_period_days??null,metadata:e.metadata};try{await a.Z.insert(i.prices).values(t).onConflictDoUpdate({target:i.prices.id,set:t})}catch(e){throw Error(`Could not insert/update the price ${e}`)}console.log(`Price inserted/updated: ${e.id}`)},c=async({email:e,uuid:t})=>{try{let e=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.id,t)});if(!e)throw Error();return e.stripeCustomerId}catch(s){let r={metadata:{supabaseUUID:t}};e&&(r.email=e);try{let e=await n.A.customers.create(r);return await a.Z.insert(i.customers).values({id:t,stripeCustomerId:e.id}),console.log(`New customer created and inserted for ${t}.`),e.id}catch(e){throw Error("Could not create Customer or find the customer")}}},u=async(e,t)=>{let r=t.customer,{name:o,phone:d,address:l}=t.billing_details;if(o&&d&&l){await n.A.customers.update(r,{name:o,phone:d,address:l});try{await a.Z.update(i.users).set({billingAddress:{...l},paymentMethod:{...t[t.type]}}).where((0,s.eq)(i.users.id,e))}catch(e){throw Error("Couldnot copy customer billing details")}}},p=async(e,t,r=!1)=>{try{let s=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.stripeCustomerId,t)});if(!s)throw Error("\uD83D\uDD34Cannot find the customer");let{id:d}=s,l=await n.A.subscriptions.retrieve(e,{expand:["default_payment_method"]});console.log("\uD83D\uDFE2UPDATED to  ",l.status);let c={id:l.id,userId:d,metadata:l.metadata,status:l.status,priceId:l.items.data[0].price.id,quantity:l.quantity,cancelAtPeriodEnd:l.cancel_at_period_end,cancelAt:l.cancel_at?(0,o.jQ)(l.cancel_at).toISOString():null,canceledAt:l.canceled_at?(0,o.jQ)(l.canceled_at).toISOString():null,currentPeriodStart:(0,o.jQ)(l.current_period_start).toISOString(),currentPeriodEnd:(0,o.jQ)(l.current_period_end).toISOString(),endedAt:l.ended_at?(0,o.jQ)(l.ended_at).toISOString():null,trialStart:l.trial_start?(0,o.jQ)(l.trial_start).toISOString():null,trialEnd:l.trial_end?(0,o.jQ)(l.trial_end).toISOString():null};await a.Z.insert(i.subscriptions).values(c).onConflictDoUpdate({target:i.subscriptions.id,set:c}),console.log(`Inserted/updated subscription [${l.id}] for user [${d}]`),r&&l.default_payment_method&&d&&await u(d,l.default_payment_method)}catch(e){throw e}}},84970:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var a=r(60709);let i=new a.Z(process.env.STRIPE_SECRET_KEY??"",{apiVersion:"2023-10-16",appInfo:{name:"Cypress",version:"0.1.0"}})},48386:(e,t,r)=>{"use strict";r.d(t,{Z:()=>l});var a=r(9847),i=r(8473),n=r(56718),s=r(26504);n.config({path:".env"}),process.env.DATABASE_URL||console.log("no database URL");let o=(0,i.Z)(process.env.DATABASE_URL,{max:1}),d=(0,a.t)(o,{schema:s}),l=d},92974:(e,t,r)=>{"use strict";r.d(t,{Ax:()=>o,cn:()=>n,jQ:()=>s});var a=r(35143),i=r(15011);function n(...e){return(0,i.m6)((0,a.W)(e))}let s=e=>{var t=new Date("1970-01-01T00:30:00Z");return t.setSeconds(e),t},o=()=>{let e="http://localhost:3000/";return"/"===(e=e.includes("http")?e:`https://${e}`).charAt(e.length-1)?e:`${e}/`}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[271,524,732,55,107,27],()=>r(79767));module.exports=a})();