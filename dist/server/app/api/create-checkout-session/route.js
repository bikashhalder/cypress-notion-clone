(()=>{var e={};e.id=737,e.ids=[737],e.modules={30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},4074:e=>{"use strict";e.exports=require("perf_hooks")},85477:e=>{"use strict";e.exports=require("punycode")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},82827:(e,t,r)=>{"use strict";r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>v,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>g});var a={};r.r(a),r.d(a,{POST:()=>m});var i=r(10884),s=r(16132),n=r(21040),o=r(84970),d=r(4999),c=r(92974),l=r(46813),u=r(24596),p=r(95798);async function m(e){let{price:t,quantity:r=1,metadata:a={}}=await e.json();try{let e=(0,l.createRouteHandlerClient)({cookies:u.cookies}),{data:{user:i}}=await e.auth.getUser(),s=await (0,d.F2)({email:i?.email||"",uuid:i?.id||""}),n=await o.A.checkout.sessions.create({payment_method_types:["card"],billing_address_collection:"required",customer:s,line_items:[{price:t.id,quantity:r}],mode:"subscription",allow_promotion_codes:!0,subscription_data:{trial_from_plan:!0,metadata:a},success_url:`${(0,c.Ax)()}/dashboard`,cancel_url:`${(0,c.Ax)()}/dashboard`});return p.Z.json({sessionId:n.id})}catch(e){return console.log(e),new p.Z("Internal Error",{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/create-checkout-session/route",pathname:"/api/create-checkout-session",filename:"route",bundlePath:"app/api/create-checkout-session/route"},resolvedPagePath:"G:\\notion\\src\\app\\api\\create-checkout-session\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:_,staticGenerationAsyncStorage:h,serverHooks:y,headerHooks:w,staticGenerationBailout:g}=f,v="/api/create-checkout-session/route";function A(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},26504:(e,t,r)=>{"use strict";r.r(t),r.d(t,{aalLevel:()=>w,codeChallengeMethod:()=>g,collaborators:()=>j,customers:()=>q,factorStatus:()=>y,factorType:()=>h,files:()=>N,folders:()=>b,keyStatus:()=>f,keyType:()=>_,prices:()=>k,pricesRelations:()=>D,pricingPlanInterval:()=>A,pricingType:()=>v,products:()=>T,productsRelations:()=>E,subscriptionStatus:()=>x,subscriptions:()=>S,users:()=>I,workspaces:()=>L});var a=r(92150),i=r(92407),s=r(73734),n=r(33789),o=r(63750),d=r(45191),c=r(55390),l=r(44406),u=r(10009),p=r(50091),m=r(54277);let f=(0,a.ys)("key_status",["default","valid","invalid","expired"]),_=(0,a.ys)("key_type",["aead-ietf","aead-det","hmacsha512","hmacsha256","auth","shorthash","generichash","kdf","secretbox","secretstream","stream_xchacha20"]),h=(0,a.ys)("factor_type",["totp","webauthn"]),y=(0,a.ys)("factor_status",["unverified","verified"]),w=(0,a.ys)("aal_level",["aal1","aal2","aal3"]),g=(0,a.ys)("code_challenge_method",["s256","plain"]),v=(0,a.ys)("pricing_type",["one_time","recurring"]),A=(0,a.ys)("pricing_plan_interval",["day","week","month","year"]),x=(0,a.ys)("subscription_status",["trialing","active","canceled","incomplete","incomplete_expired","past_due","unpaid"]),L=(0,i.af)("workspaces",{id:(0,s.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),workspaceOwner:(0,s.Vj)("workspace_owner").notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),logo:(0,o.fL)("logo"),bannerUrl:(0,o.fL)("banner_url")}),b=(0,i.af)("folders",{id:(0,s.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),bannerUrl:(0,o.fL)("banner_url"),workspaceId:(0,s.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"})}),N=(0,i.af)("files",{id:(0,s.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,o.fL)("title").notNull(),iconId:(0,o.fL)("icon_id").notNull(),data:(0,o.fL)("data"),inTrash:(0,o.fL)("in_Trash"),bannerUrl:(0,o.fL)("banner_url"),workspaceId:(0,s.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"}),folderId:(0,s.Vj)("folder_id").notNull().references(()=>b.id,{onDelete:"cascade"})}),I=(0,i.af)("users",{id:(0,s.Vj)("id").primaryKey().notNull(),fullName:(0,o.fL)("full_name"),avatarUrl:(0,o.fL)("avatar_url"),billingAddress:(0,d.JB)("billing_address"),updatedAt:(0,n.AB)("updated_at",{withTimezone:!0,mode:"string"}),paymentMethod:(0,d.JB)("payment_method"),email:(0,o.fL)("email")}),q=(0,i.af)("customers",{id:(0,s.Vj)("id").primaryKey().notNull(),stripeCustomerId:(0,o.fL)("stripe_customer_id")}),k=(0,i.af)("prices",{id:(0,o.fL)("id").primaryKey().notNull(),productId:(0,o.fL)("product_id").references(()=>T.id),active:(0,c.O7)("active"),description:(0,o.fL)("description"),unitAmount:(0,l.Kv)("unit_amount",{mode:"number"}),currency:(0,o.fL)("currency"),type:v("type"),interval:A("interval"),intervalCount:(0,u._L)("interval_count"),trialPeriodDays:(0,u._L)("trial_period_days"),metadata:(0,d.JB)("metadata")}),T=(0,i.af)("products",{id:(0,o.fL)("id").primaryKey().notNull(),active:(0,c.O7)("active"),name:(0,o.fL)("name"),description:(0,o.fL)("description"),image:(0,o.fL)("image"),metadata:(0,d.JB)("metadata")}),S=(0,i.af)("subscriptions",{id:(0,o.fL)("id").primaryKey().notNull(),userId:(0,s.Vj)("user_id").notNull(),status:x("status"),metadata:(0,d.JB)("metadata"),priceId:(0,o.fL)("price_id").references(()=>k.id),quantity:(0,u._L)("quantity"),cancelAtPeriodEnd:(0,c.O7)("cancel_at_period_end"),created:(0,n.AB)("created",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodStart:(0,n.AB)("current_period_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodEnd:(0,n.AB)("current_period_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),endedAt:(0,n.AB)("ended_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),cancelAt:(0,n.AB)("cancel_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),canceledAt:(0,n.AB)("canceled_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialStart:(0,n.AB)("trial_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialEnd:(0,n.AB)("trial_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`)}),j=(0,i.af)("collaborators",{workspaceId:(0,s.Vj)("workspace_id").notNull().references(()=>L.id,{onDelete:"cascade"}),cancelAt:(0,n.AB)("cancel_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),userId:(0,s.Vj)("user_id").notNull().references(()=>I.id,{onDelete:"cascade"}),id:(0,s.Vj)("id").defaultRandom().notNull()}),E=(0,m.lE)(T,({many:e})=>({prices:e(k)})),D=(0,m.lE)(k,({one:e})=>({product:e(T,{fields:[k.productId],references:[T.id]})}))},4999:(e,t,r)=>{"use strict";r.d(t,{CM:()=>p,F2:()=>l,OF:()=>c,aU:()=>d});var a=r(48386),i=r(26504),s=r(84970),n=r(50161),o=r(92974);let d=async e=>{let t={id:e.id,active:e.active,name:e.name,description:e.description??null,image:e.images?.[0]??null,metadata:e.metadata};try{await a.Z.insert(i.products).values(t).onConflictDoUpdate({target:i.products.id,set:t})}catch(e){throw Error()}console.log("Product inserted/updates:",e.id)},c=async e=>{console.log(e,"PRICE");let t={id:e.id,productId:"string"==typeof e.product?e.product:null,active:e.active,currency:e.currency,description:e.nickname??null,type:e.type,unitAmount:e.unit_amount??null,interval:e.recurring?.interval??null,intervalCount:e.recurring?.interval_count??null,trialPeriodDays:e.recurring?.trial_period_days??null,metadata:e.metadata};try{await a.Z.insert(i.prices).values(t).onConflictDoUpdate({target:i.prices.id,set:t})}catch(e){throw Error(`Could not insert/update the price ${e}`)}console.log(`Price inserted/updated: ${e.id}`)},l=async({email:e,uuid:t})=>{try{let e=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.id,t)});if(!e)throw Error();return e.stripeCustomerId}catch(n){let r={metadata:{supabaseUUID:t}};e&&(r.email=e);try{let e=await s.A.customers.create(r);return await a.Z.insert(i.customers).values({id:t,stripeCustomerId:e.id}),console.log(`New customer created and inserted for ${t}.`),e.id}catch(e){throw Error("Could not create Customer or find the customer")}}},u=async(e,t)=>{let r=t.customer,{name:o,phone:d,address:c}=t.billing_details;if(o&&d&&c){await s.A.customers.update(r,{name:o,phone:d,address:c});try{await a.Z.update(i.users).set({billingAddress:{...c},paymentMethod:{...t[t.type]}}).where((0,n.eq)(i.users.id,e))}catch(e){throw Error("Couldnot copy customer billing details")}}},p=async(e,t,r=!1)=>{try{let n=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.stripeCustomerId,t)});if(!n)throw Error("\uD83D\uDD34Cannot find the customer");let{id:d}=n,c=await s.A.subscriptions.retrieve(e,{expand:["default_payment_method"]});console.log("\uD83D\uDFE2UPDATED to  ",c.status);let l={id:c.id,userId:d,metadata:c.metadata,status:c.status,priceId:c.items.data[0].price.id,quantity:c.quantity,cancelAtPeriodEnd:c.cancel_at_period_end,cancelAt:c.cancel_at?(0,o.jQ)(c.cancel_at).toISOString():null,canceledAt:c.canceled_at?(0,o.jQ)(c.canceled_at).toISOString():null,currentPeriodStart:(0,o.jQ)(c.current_period_start).toISOString(),currentPeriodEnd:(0,o.jQ)(c.current_period_end).toISOString(),endedAt:c.ended_at?(0,o.jQ)(c.ended_at).toISOString():null,trialStart:c.trial_start?(0,o.jQ)(c.trial_start).toISOString():null,trialEnd:c.trial_end?(0,o.jQ)(c.trial_end).toISOString():null};await a.Z.insert(i.subscriptions).values(l).onConflictDoUpdate({target:i.subscriptions.id,set:l}),console.log(`Inserted/updated subscription [${c.id}] for user [${d}]`),r&&c.default_payment_method&&d&&await u(d,c.default_payment_method)}catch(e){throw e}}},84970:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var a=r(60709);let i=new a.Z(process.env.STRIPE_SECRET_KEY??"",{apiVersion:"2023-10-16",appInfo:{name:"Cypress",version:"0.1.0"}})},48386:(e,t,r)=>{"use strict";r.d(t,{Z:()=>c});var a=r(9847),i=r(8473),s=r(56718),n=r(26504);s.config({path:".env"}),process.env.DATABASE_URL||console.log("no database URL");let o=(0,i.Z)(process.env.DATABASE_URL,{max:1}),d=(0,a.t)(o,{schema:n}),c=d},92974:(e,t,r)=>{"use strict";r.d(t,{Ax:()=>o,cn:()=>s,jQ:()=>n});var a=r(35143),i=r(15011);function s(...e){return(0,i.m6)((0,a.W)(e))}let n=e=>{var t=new Date("1970-01-01T00:30:00Z");return t.setSeconds(e),t},o=()=>{let e="http://localhost:3000/";return"/"===(e=e.includes("http")?e:`https://${e}`).charAt(e.length-1)?e:`${e}/`}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[271,524,732,55,107,27],()=>r(82827));module.exports=a})();