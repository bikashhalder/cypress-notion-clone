"use strict";(()=>{var e={};e.id=570,e.ids=[570],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},25528:e=>{e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},22037:e=>{e.exports=require("os")},71017:e=>{e.exports=require("path")},4074:e=>{e.exports=require("perf_hooks")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},73837:e=>{e.exports=require("util")},23279:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{POST:()=>p});var i=r(10884),o=r(16132),n=r(21040),s=r(84970),d=r(4999),c=r(24596),l=r(95798);let u=new Set(["product.created","product.updated","price.created","price.updated","checkout.session.completed","customer.subscription.created","customer.subscription.updated","customer.subscription.deleted"]);async function p(e){let t;let r=await e.text(),a=(0,c.headers)().get("Stripe-Signature"),i=process.env.STRIPE_WEBHOOK_SECRET_LIVE??process.env.STRIPE_WEBHOOK_SECRET;try{if(!a||!i)return;t=s.A.webhooks.constructEvent(r,a,i)}catch(e){return console.log(`Error message: ${e.message}`),new l.Z(`Webhook Error: ${e.message}`,{status:400})}if(u.has(t.type))try{switch(t.type){case"product.created":case"product.updated":await (0,d.aU)(t.data.object);break;case"price.created":case"price.updated":await (0,d.OF)(t.data.object);case"customer.subscription.created":case"customer.subscription.updated":case"customer.subscription.deleted":let e=t.data.object;await (0,d.CM)(e.id,e.customer,"customer.subscription.created"===t.type),console.log("FROM WEBHOOK\uD83D\uDE80",e.status);break;case"checkout.session.completed":let r=t.data.object;if("subscription"===r.mode){let e=r.subscription;await (0,d.CM)(e,r.customer,!0)}break;default:throw Error("Unhandled relevant event!")}}catch(e){return console.log(e),new l.Z('Webhook error: "Webhook handler failed. View logs."',{status:400})}return l.Z.json({received:!0},{status:200})}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhook/route",pathname:"/api/webhook",filename:"route",bundlePath:"app/api/webhook/route"},resolvedPagePath:"G:\\notion\\src\\app\\api\\webhook\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:_,headerHooks:y,staticGenerationBailout:w}=m,g="/api/webhook/route";function v(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},26504:(e,t,r)=>{r.r(t),r.d(t,{aalLevel:()=>w,codeChallengeMethod:()=>g,collaborators:()=>j,customers:()=>S,factorStatus:()=>y,factorType:()=>_,files:()=>k,folders:()=>L,keyStatus:()=>f,keyType:()=>h,prices:()=>I,pricesRelations:()=>D,pricingPlanInterval:()=>b,pricingType:()=>v,products:()=>N,productsRelations:()=>q,subscriptionStatus:()=>A,subscriptions:()=>T,users:()=>x,workspaces:()=>E});var a=r(92150),i=r(92407),o=r(73734),n=r(33789),s=r(63750),d=r(45191),c=r(55390),l=r(44406),u=r(10009),p=r(50091),m=r(54277);let f=(0,a.ys)("key_status",["default","valid","invalid","expired"]),h=(0,a.ys)("key_type",["aead-ietf","aead-det","hmacsha512","hmacsha256","auth","shorthash","generichash","kdf","secretbox","secretstream","stream_xchacha20"]),_=(0,a.ys)("factor_type",["totp","webauthn"]),y=(0,a.ys)("factor_status",["unverified","verified"]),w=(0,a.ys)("aal_level",["aal1","aal2","aal3"]),g=(0,a.ys)("code_challenge_method",["s256","plain"]),v=(0,a.ys)("pricing_type",["one_time","recurring"]),b=(0,a.ys)("pricing_plan_interval",["day","week","month","year"]),A=(0,a.ys)("subscription_status",["trialing","active","canceled","incomplete","incomplete_expired","past_due","unpaid"]),E=(0,i.af)("workspaces",{id:(0,o.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),workspaceOwner:(0,o.Vj)("workspace_owner").notNull(),title:(0,s.fL)("title").notNull(),iconId:(0,s.fL)("icon_id").notNull(),data:(0,s.fL)("data"),inTrash:(0,s.fL)("in_Trash"),logo:(0,s.fL)("logo"),bannerUrl:(0,s.fL)("banner_url")}),L=(0,i.af)("folders",{id:(0,o.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,s.fL)("title").notNull(),iconId:(0,s.fL)("icon_id").notNull(),data:(0,s.fL)("data"),inTrash:(0,s.fL)("in_Trash"),bannerUrl:(0,s.fL)("banner_url"),workspaceId:(0,o.Vj)("workspace_id").notNull().references(()=>E.id,{onDelete:"cascade"})}),k=(0,i.af)("files",{id:(0,o.Vj)("id").defaultRandom().primaryKey().notNull(),createdAt:(0,n.AB)("created_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),title:(0,s.fL)("title").notNull(),iconId:(0,s.fL)("icon_id").notNull(),data:(0,s.fL)("data"),inTrash:(0,s.fL)("in_Trash"),bannerUrl:(0,s.fL)("banner_url"),workspaceId:(0,o.Vj)("workspace_id").notNull().references(()=>E.id,{onDelete:"cascade"}),folderId:(0,o.Vj)("folder_id").notNull().references(()=>L.id,{onDelete:"cascade"})}),x=(0,i.af)("users",{id:(0,o.Vj)("id").primaryKey().notNull(),fullName:(0,s.fL)("full_name"),avatarUrl:(0,s.fL)("avatar_url"),billingAddress:(0,d.JB)("billing_address"),updatedAt:(0,n.AB)("updated_at",{withTimezone:!0,mode:"string"}),paymentMethod:(0,d.JB)("payment_method"),email:(0,s.fL)("email")}),S=(0,i.af)("customers",{id:(0,o.Vj)("id").primaryKey().notNull(),stripeCustomerId:(0,s.fL)("stripe_customer_id")}),I=(0,i.af)("prices",{id:(0,s.fL)("id").primaryKey().notNull(),productId:(0,s.fL)("product_id").references(()=>N.id),active:(0,c.O7)("active"),description:(0,s.fL)("description"),unitAmount:(0,l.Kv)("unit_amount",{mode:"number"}),currency:(0,s.fL)("currency"),type:v("type"),interval:b("interval"),intervalCount:(0,u._L)("interval_count"),trialPeriodDays:(0,u._L)("trial_period_days"),metadata:(0,d.JB)("metadata")}),N=(0,i.af)("products",{id:(0,s.fL)("id").primaryKey().notNull(),active:(0,c.O7)("active"),name:(0,s.fL)("name"),description:(0,s.fL)("description"),image:(0,s.fL)("image"),metadata:(0,d.JB)("metadata")}),T=(0,i.af)("subscriptions",{id:(0,s.fL)("id").primaryKey().notNull(),userId:(0,o.Vj)("user_id").notNull(),status:A("status"),metadata:(0,d.JB)("metadata"),priceId:(0,s.fL)("price_id").references(()=>I.id),quantity:(0,u._L)("quantity"),cancelAtPeriodEnd:(0,c.O7)("cancel_at_period_end"),created:(0,n.AB)("created",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodStart:(0,n.AB)("current_period_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),currentPeriodEnd:(0,n.AB)("current_period_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`).notNull(),endedAt:(0,n.AB)("ended_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),cancelAt:(0,n.AB)("cancel_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),canceledAt:(0,n.AB)("canceled_at",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialStart:(0,n.AB)("trial_start",{withTimezone:!0,mode:"string"}).default(p.i6`now()`),trialEnd:(0,n.AB)("trial_end",{withTimezone:!0,mode:"string"}).default(p.i6`now()`)}),j=(0,i.af)("collaborators",{workspaceId:(0,o.Vj)("workspace_id").notNull().references(()=>E.id,{onDelete:"cascade"}),cancelAt:(0,n.AB)("cancel_at",{withTimezone:!0,mode:"string"}).defaultNow().notNull(),userId:(0,o.Vj)("user_id").notNull().references(()=>x.id,{onDelete:"cascade"}),id:(0,o.Vj)("id").defaultRandom().notNull()}),q=(0,m.lE)(N,({many:e})=>({prices:e(I)})),D=(0,m.lE)(I,({one:e})=>({product:e(N,{fields:[I.productId],references:[N.id]})}))},4999:(e,t,r)=>{r.d(t,{CM:()=>p,F2:()=>l,OF:()=>c,aU:()=>d});var a=r(48386),i=r(26504),o=r(84970),n=r(50161),s=r(92974);let d=async e=>{let t={id:e.id,active:e.active,name:e.name,description:e.description??null,image:e.images?.[0]??null,metadata:e.metadata};try{await a.Z.insert(i.products).values(t).onConflictDoUpdate({target:i.products.id,set:t})}catch(e){throw Error()}console.log("Product inserted/updates:",e.id)},c=async e=>{console.log(e,"PRICE");let t={id:e.id,productId:"string"==typeof e.product?e.product:null,active:e.active,currency:e.currency,description:e.nickname??null,type:e.type,unitAmount:e.unit_amount??null,interval:e.recurring?.interval??null,intervalCount:e.recurring?.interval_count??null,trialPeriodDays:e.recurring?.trial_period_days??null,metadata:e.metadata};try{await a.Z.insert(i.prices).values(t).onConflictDoUpdate({target:i.prices.id,set:t})}catch(e){throw Error(`Could not insert/update the price ${e}`)}console.log(`Price inserted/updated: ${e.id}`)},l=async({email:e,uuid:t})=>{try{let e=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.id,t)});if(!e)throw Error();return e.stripeCustomerId}catch(n){let r={metadata:{supabaseUUID:t}};e&&(r.email=e);try{let e=await o.A.customers.create(r);return await a.Z.insert(i.customers).values({id:t,stripeCustomerId:e.id}),console.log(`New customer created and inserted for ${t}.`),e.id}catch(e){throw Error("Could not create Customer or find the customer")}}},u=async(e,t)=>{let r=t.customer,{name:s,phone:d,address:c}=t.billing_details;if(s&&d&&c){await o.A.customers.update(r,{name:s,phone:d,address:c});try{await a.Z.update(i.users).set({billingAddress:{...c},paymentMethod:{...t[t.type]}}).where((0,n.eq)(i.users.id,e))}catch(e){throw Error("Couldnot copy customer billing details")}}},p=async(e,t,r=!1)=>{try{let n=await a.Z.query.customers.findFirst({where:(e,{eq:r})=>r(e.stripeCustomerId,t)});if(!n)throw Error("\uD83D\uDD34Cannot find the customer");let{id:d}=n,c=await o.A.subscriptions.retrieve(e,{expand:["default_payment_method"]});console.log("\uD83D\uDFE2UPDATED to  ",c.status);let l={id:c.id,userId:d,metadata:c.metadata,status:c.status,priceId:c.items.data[0].price.id,quantity:c.quantity,cancelAtPeriodEnd:c.cancel_at_period_end,cancelAt:c.cancel_at?(0,s.jQ)(c.cancel_at).toISOString():null,canceledAt:c.canceled_at?(0,s.jQ)(c.canceled_at).toISOString():null,currentPeriodStart:(0,s.jQ)(c.current_period_start).toISOString(),currentPeriodEnd:(0,s.jQ)(c.current_period_end).toISOString(),endedAt:c.ended_at?(0,s.jQ)(c.ended_at).toISOString():null,trialStart:c.trial_start?(0,s.jQ)(c.trial_start).toISOString():null,trialEnd:c.trial_end?(0,s.jQ)(c.trial_end).toISOString():null};await a.Z.insert(i.subscriptions).values(l).onConflictDoUpdate({target:i.subscriptions.id,set:l}),console.log(`Inserted/updated subscription [${c.id}] for user [${d}]`),r&&c.default_payment_method&&d&&await u(d,c.default_payment_method)}catch(e){throw e}}},84970:(e,t,r)=>{r.d(t,{A:()=>i});var a=r(60709);let i=new a.Z(process.env.STRIPE_SECRET_KEY??"",{apiVersion:"2023-10-16",appInfo:{name:"Cypress",version:"0.1.0"}})},48386:(e,t,r)=>{r.d(t,{Z:()=>c});var a=r(9847),i=r(8473),o=r(56718),n=r(26504);o.config({path:".env"}),process.env.DATABASE_URL||console.log("no database URL");let s=(0,i.Z)(process.env.DATABASE_URL,{max:1}),d=(0,a.t)(s,{schema:n}),c=d},92974:(e,t,r)=>{r.d(t,{Ax:()=>s,cn:()=>o,jQ:()=>n});var a=r(35143),i=r(15011);function o(...e){return(0,i.m6)((0,a.W)(e))}let n=e=>{var t=new Date("1970-01-01T00:30:00Z");return t.setSeconds(e),t},s=()=>{let e="http://localhost:3000/";return"/"===(e=e.includes("http")?e:`https://${e}`).charAt(e.length-1)?e:`${e}/`}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[271,524,732,107,27],()=>r(23279));module.exports=a})();